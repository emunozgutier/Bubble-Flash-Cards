export const SILENT_MP3 = 'data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjI5LjEwMAAAAAAAAAAAAAAA//OEAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAAZAAABFwAAA0cAAAAAAAD/84QAAAAAAAAAAAAAAAAAAAAAALavZjgAAAAAABFwAAAAAAAAAAAA//OEMAAAAAAAEfAAAAAAAAAAASW5mbwAAAA8AAAAZAAABFwAAA0cAAAAAAAD/84QAAAAAAAAAAAAAAAAAAAAAALavZjgAAAAAABFwAAAAAAAAAAAA//OEMAAAAAAAEfAAAAAAAAAAASW5mbwAAAA8AAAAZAAABFwAAA0cAAAAAAAD/84QAAAAAAAAAAAAAAAAAAAAAALavZjgAAAAAABFwAAAAAAAAAAAA//OEMAAAAAAAEfAAAAAAAAAAASW5mbwAAAA8AAAAZAAABFwAAA0cAAAAAAAD/84QAAAAAAAAAAAAAAAAAAAAAALavZjgAAAAAABFwAAAAAAAAAAAA//OEMAAAAAAAEfAAAAAAAAAAASW5mbwAAAA8AAAAZAAABFwAAA0cAAAAAAAD/84QAAAAAAAAAAAAAAAAAAAAAALavZjgAAAAAABFwAAAAAAAAAAAA//OEMAAAAAAAEfAAAAAAAAAAASW5mbwAAAA8AAAAZAAABFwAAA0cAAAAAAAD/84QAAAAAAAAAAAAAAAAAAAAAALavZjgAAAAAABFwAAAAAAAAAAAA//OEMAAAAAAAEfAAAAAAAAAAASW5mbwAAAA8AAAAZAAABFwAAA0cAAAAAAAD/84QAAAAAAAAAAAAAAAAAAAAAALavZjgAAAAAABFwAAAAAAAAAAAA//OEMAAAAAAAEfAAAAAAAAAAASW5mbwAAAA8AAAAZAAABFwAAA0cAAAAAAAD/84QAAAAAAAAAAAAAAAAAAAAAALavZjgAAAAAABFwAAAAAAAAAAAA//OEMAAAAAAAEfAAAAAAAAAAASW5mbwAAAA8AAAAZAAABFwAAA0cAAAAAAAD/84QAAAAAAAAAAAAAAAAAAAAAALavZjgAAAAAABFwAAAAAAAAAAAA//OEMAAAAAAAEfAAAAAAAAAAASW5mbwAAAA8AAAAZAAABFwAAA0cAAAAAAAD/84QAAAAAAAAAAAAAAAAAAAAAALavZjgAAAAAABFwAAAAAAAAAAAA//OEMAAAAAAAEfAAAAAAAAAAASW5mbwAAAA8AAAAZAAABFwAAA0cAAAAAAAD/84QAAAAAAAAAAAAAAAAAAAAAALavZjgAAAAAABFwAAAAAAAAAAAA//OEMAAAAAAAEfAAAAAAAAAAASW5mbwAAAA8AAAAZAAABFwAAA0cAAAAAAAD/84QAAAAAAAAAAAAAAAAAAAAAALavZjgAAAAAABFwAAAAAAAAAAAA//OEMAAAAAAAEfAAAAAAAAAAASW5mbwAAAA8AAAAZAAABFwAAA0cAAAAAAAD/84QAAAAAAAAAAAAAAAAAAAAAALavZjgAAAAAABFwAAAAAAAAAAAA//OEMAAAAAAAEfAAAAAAAAAAASW5mbwAAAA8AAAAZAAABFwAAA0cAAAAAAAD/84QAAAAAAAAAAAAAAAAAAAAAALavZjgAAAAAABFwAAAAAAAAAAAA//OEMAAAAAAAEfAAAAAAAAAAASW5mbwAAAA8AAAAZAAABFwAAA0cAAAAAAAD/84QAAAAAAAAAAAAAAAAAAAAAALavZjgAAAAAABFwAAAAAAAAAAAA//OEMAAAAAAAEfAAAAAAAAAAASW5mbwAAAA8AAAAZAAABFwAAA0cAAAAAAAD/84QAAAAAAAAAAAAAAAAAAAAAALavZjgAAAAAABFwAAAAAAAAAAAA//OEMAAAAAAAEfAAAAAAAAAAASW5mbwAAAA8AAAAZAAABFwAAA0cAAAAAAAD/84QAAAAAAAAAAAAAAAAAAAAAALavZjgAAAAAABFwAAAAAAAAAAAA//OEMAAAAAAAEfAAAAAAAAAAASW5mbwAAAA8AAAAZAAABFwAAA0cAAAAAAAD/84QAAAAAAAAAAAAAAAAAAAAAALavZjgAAAAAABFwAAAAAAAAAAAA//OEMAAAAAAAEfAAAAAAAAAAASW5mbwAAAA8AAAAZAAABFwAAA0cAAAAAAAD/84QAAAAAAAAAAAAAAAAAAAAAALavZjgAAAAAABFwAAAAAAAAAAAA//OEMAAAAAAAEfAAAAAAAAAAASW5mbwAAAA8AAAAZAAABFwAAA0cAAAAAAAD/84QAAAAAAAAAAAAAAAAAAAAAALavZjgAAAAAABFwAAAAAAAAAAAA//OEMAAAAAAAEfAAAAAAAAAAASW5mbwAAAA8AAAAZAAABFwAAA0cAAAAAAAD/84QAAAAAAAAAAAAAAAAAAAAAALavZjgAAAAAABFwAAAAAAAAAAAA//OEMAAAAAAAEfAAAAAAAAAAASW5mbwAAAA8AAAAZAAABFwAAA0cAAAAAAAD/84QAAAAAAAAAAAAAAAAAAAAAALavZjgAAAAAABFwAAAAAAAAAAAA//OEMAAAAAAAEfAAAAAAAAAAASW5mbwAAAA8AAAAZAAABFwAAA0cAAAAAAAD/84QAAAAAAAAAAAAAAAAAAAAAALavZjgAAAAAABFwAAAAAAAAAAAA//OEMAAAAAAAEfAAAAAAAAAAASW5mbwAAAA8AAAAZAAABFwAAA0cAAAAAAAD/84QAAAAAAAAAAAAAAAAAAAAAALavZjgAAAAAABFwAAAAAAAAAAAA//OEMAAAAAAAEfAAAAAAAAAAASW5mbwAAAA8AAAAZAAABFwAAA0cAAAAAAAD/84QAAAAAAAAAAAAAAAAAAAAAALavZjgAAAAAABFwAAAAAAAAAAAA//OEMAAAAAAAEfAAAAAAAAAAASW5mbwAAAA8AAAAZAAABFwAAA0cAAAAAAAD/84QAAAAAAAAAAAAAAAAAAAAAALavZjgAAAAAABFwAAAAAAAAAAAA//OEMAAAAAAAEfAAAAAAAAAAASW5mbwAAAA8AAAAZAAABFwAAA0cAAAAAAAD/84QAAAAAAAAAAAAAAAAAAAAAALavZjgAAAAAABFwAAAAAAAAAAAA//OEMAAAAAAAEfAAAAAAAAAAASW5mbwAAAA8AAAAZAAABFwAAA0cAAAAAAAD/84QAAAAAAAAAAAAAAAAAAAAAALavZjgAAAAAABFwAAAAAAAAAAAA//OEMAAAAAAAEfAAAAAAAAAAASW5mbwAAAA8AAAAZAAABFwAAA0cAAAAAAAD/84QAAAAAAAAAAAAAAAAAAAAAALavZjgAAAAAABFwAAAAAAAAAAAA//OEMAAAAAAAEfAAAAAAAAAAASW5mbwAAAA8AAAAZAAABFwAAA0cAAAAAAAD/84QAAAAAAAAAAAAAAAAAAAAAALavZjgAAAAAABFwAAAAAAAAAAAA//OEMAAAAAAAEfAAAAAAAAAAASW5mbwAAAA8AAAAZAAABFwAAA0cAAAAAAAD/84QAAAAAAAAAAAAAAAAAAAAAALavZjgAAAAAABFwAAAAAAAAAAAA//OEMAAAAAAAEfAAAAAAAAAAASW5mbwAAAA8AAAAZAAABFwAAA0cAAAAAAAD/84QAAAAAAAAAAAAAAAAAAAAAALavZjgAAAAAABFwAAAAAAAAAAAA//OEMAAAAAAAEfAAAAAAAAAAASW5mbwAAAA8AAAAZAAABFwAAA0cAAAAAAAD/84QAAAAAAAAAAAAAAAAAAAAAALavZjgAAAAAABFwAAAAAAAAAAAA//OEMAAAAAAAEfAAAAAAAAAAASW5mbwAAAA8AAAAZAAABFwAAA0cAAAAAAAD/84QAAAAAAAAAAAAAAAAAAAAAALavZjgAAAAAABFwAAAAAAAAAAAA';

export const speak = (text, rate = 1.0, log = console.log) => {
    if (!text) return;
    log(`Speaking: ${text.substring(0, 10)}... @ ${rate}`);

    // Cancel persistent synthesis (or overlap?)
    window.speechSynthesis.cancel();

    // Use Chinese voice if text has Chinese, else English
    // Heuristic: Check for Chinese characters
    const isChinese = /[\u4E00-\u9FFF]/.test(text);

    const utterance = new SpeechSynthesisUtterance(text);
    utterance.rate = rate; // 1.0 = normal, 0.25 = slow

    // Find voice
    const voices = window.speechSynthesis.getVoices();
    if (isChinese) {
        const zhVoice = voices.find(v => v.lang.includes('zh')); // zh-CN, zh-HK, zh-TW
        if (zhVoice) utterance.voice = zhVoice;
    } else {
        // Prefer English
        const enVoice = voices.find(v => v.lang.startsWith('en'));
        if (enVoice) utterance.voice = enVoice;
    }

    window.speechSynthesis.speak(utterance);
};

export const initMediaSession = ({ onNext, onPrev, onPlay, onPause, title, artist, album, log = console.log }) => {
    if ('mediaSession' in navigator) {
        log("MediaSession available");
        navigator.mediaSession.metadata = new MediaMetadata({
            title: title || 'Hands Free Practice',
            artist: artist || 'Flash Cards',
            album: album || 'Bubble Game'
        });

        if (onNext) navigator.mediaSession.setActionHandler('nexttrack', () => { log("Media: Next"); onNext(); });
        if (onPrev) navigator.mediaSession.setActionHandler('previoustrack', () => { log("Media: Prev"); onPrev(); });
        if (onPlay) navigator.mediaSession.setActionHandler('play', () => { log("Media: Play"); onPlay(); });
        if (onPause) navigator.mediaSession.setActionHandler('pause', () => { log("Media: Pause"); onPause(); });

        return () => {
            navigator.mediaSession.setActionHandler('nexttrack', null);
            navigator.mediaSession.setActionHandler('previoustrack', null);
            navigator.mediaSession.setActionHandler('play', null);
            navigator.mediaSession.setActionHandler('pause', null);
        };
    } else {
        log("MediaSession NOT available");
        return () => { };
    }
};

export const updateMediaMetadata = (title, artist) => {
    if ('mediaSession' in navigator) {
        if (title) navigator.mediaSession.metadata.title = title;
        if (artist) navigator.mediaSession.metadata.artist = artist;
    }
};

export const warmupAudio = (audioElement, log = console.log) => {
    if (!audioElement) return;

    // 1. Resume Audio Context / Play Silent Audio
    audioElement.volume = 0.1;
    audioElement.play()
        .then(() => log("Audio Context resumed"))
        .catch(e => log(`Audio Error: ${e.message}`));

    // 2. Warm up Speech Synthesis
    try {
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance('');
        window.speechSynthesis.speak(utterance);
        log("Speech Synthesis warmed up");
    } catch (e) {
        log(`Speech Synthesis Error: ${e.message}`);
    }
};

export const setupSpeechRecognition = ({ onResult, onError, log = console.log }) => {
    if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
        log("Speech Recognition NOT supported");
        return null;
    }

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new SpeechRecognition();
    recognition.continuous = true;
    recognition.interimResults = true;
    recognition.lang = 'en-US';

    recognition.onresult = (event) => {
        let interimTranscript = '';
        let finalTranscript = '';

        for (let i = event.resultIndex; i < event.results.length; ++i) {
            if (event.results[i].isFinal) {
                finalTranscript += event.results[i][0].transcript;
            } else {
                interimTranscript += event.results[i][0].transcript;
            }
        }
        onResult(finalTranscript, interimTranscript);
    };

    recognition.onerror = (event) => {
        log(`Speech Error: ${event.error}`);
        if (onError) onError(event.error);
    };

    return recognition;
};

